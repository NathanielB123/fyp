{-# OPTIONS --prop --rewriting --show-irrelevant #-}

open import Utils
open import Utils.IdExtras

open import Dependent.SCBool.Syntax

-- Like "ModelOld.agda" but without asserting termination.
--
-- To achieve this, we use some trickery with forward references, with-clauses 
-- and specialising helpers, which makes unfortunately the definitions a bit 
-- clunkier in places.
module Dependent.SCBool.Model where

âŸ¦CtxâŸ§ : Setâ‚
âŸ¦CtxâŸ§ = Set

âŸ¦TyâŸ§ : âŸ¦CtxâŸ§ â†’ Setâ‚
âŸ¦TyâŸ§ Î“ = Î“ â†’ Set

âŸ¦TmâŸ§ : âˆ€ Î“ â†’ âŸ¦TyâŸ§ Î“ â†’ Set
âŸ¦TmâŸ§ Î“ A = âˆ€ Ï â†’ A Ï

âŸ¦TmsâŸ§ : âŸ¦CtxâŸ§ â†’ âŸ¦CtxâŸ§ â†’ Set
âŸ¦TmsâŸ§ Î” Î“ = Î” â†’ Î“

variable
  âŸ¦Î“âŸ§ âŸ¦Î”âŸ§ âŸ¦Î“â‚âŸ§ âŸ¦Î“â‚‚âŸ§ âŸ¦Î”â‚âŸ§ âŸ¦Î”â‚‚âŸ§   : âŸ¦CtxâŸ§
  âŸ¦AâŸ§ âŸ¦BâŸ§ âŸ¦Aâ‚âŸ§ âŸ¦Aâ‚‚âŸ§ âŸ¦Bâ‚âŸ§ âŸ¦Bâ‚‚âŸ§   : âŸ¦TyâŸ§ âŸ¦Î“âŸ§ 
  âŸ¦tâŸ§ âŸ¦tâ‚âŸ§ âŸ¦tâ‚‚âŸ§ âŸ¦uâ‚âŸ§ âŸ¦uâ‚‚âŸ§ âŸ¦vâ‚âŸ§ âŸ¦vâ‚‚âŸ§ : âŸ¦TmâŸ§ âŸ¦Î“âŸ§ âŸ¦AâŸ§
  âŸ¦Î´â‚âŸ§ âŸ¦Î´â‚‚âŸ§                     : âŸ¦TmsâŸ§ âŸ¦Î”âŸ§ âŸ¦Î“âŸ§

Tyâ‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§ â†’ âŸ¦TyâŸ§ âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦TyâŸ§ âŸ¦Î“â‚‚âŸ§
Tyâ‰¡ refl = refl

Tmâ‰¡ : âˆ€ Î“â‰¡ â†’ âˆ€ (Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§) 
    â†’ âŸ¦TmâŸ§ âŸ¦Î“â‚âŸ§ âŸ¦Aâ‚âŸ§ â‰¡á´¾ âŸ¦TmâŸ§ âŸ¦Î“â‚‚âŸ§ âŸ¦Aâ‚‚âŸ§
Tmâ‰¡ refl refl = refl

Tmsâ‰¡ : âŸ¦Î”â‚âŸ§ â‰¡á´¾ âŸ¦Î”â‚‚âŸ§ â†’ âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§ â†’ âŸ¦TmsâŸ§ âŸ¦Î”â‚âŸ§ âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦TmsâŸ§ âŸ¦Î”â‚‚âŸ§ âŸ¦Î“â‚‚âŸ§
Tmsâ‰¡ refl refl = refl

variable
  Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§
  Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§


âŸ¦,âŸ§ = Î£

,â‰¡ : âˆ€ Î“â‰¡ â†’ âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§ â†’ âŸ¦,âŸ§ âŸ¦Î“â‚âŸ§ âŸ¦Aâ‚âŸ§ â‰¡á´¾ âŸ¦,âŸ§ âŸ¦Î“â‚‚âŸ§ âŸ¦Aâ‚‚âŸ§ 
,â‰¡ refl refl = refl

âŸ¦Î âŸ§ : âˆ€ âŸ¦AâŸ§ â†’ âŸ¦TyâŸ§ (âŸ¦,âŸ§ âŸ¦Î“âŸ§ âŸ¦AâŸ§) â†’ âŸ¦TyâŸ§ âŸ¦Î“âŸ§
âŸ¦Î âŸ§ âŸ¦AâŸ§ âŸ¦BâŸ§ = Î» Ï â†’ âˆ€ x â†’ âŸ¦BâŸ§ (Ï Î£, x)

âŸ¦ğ”¹âŸ§ : âŸ¦TyâŸ§ âŸ¦Î“âŸ§
âŸ¦ğ”¹âŸ§ = Î» _ â†’ Bool

âŸ¦,>rwâŸ§ : âˆ€ âŸ¦Î“âŸ§ â†’ âŸ¦TmâŸ§ âŸ¦Î“âŸ§ âŸ¦ğ”¹âŸ§ â†’ Bool â†’ âŸ¦CtxâŸ§
âŸ¦,>rwâŸ§ âŸ¦Î“âŸ§ âŸ¦tâŸ§ b = Î£ âŸ¦Î“âŸ§ (Î» Ï â†’ Box (âŸ¦tâŸ§ Ï â‰¡á´¾ b))

ğ”¹â‰¡ : âˆ€ (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) â†’ âŸ¦ğ”¹âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦ğ”¹âŸ§
ğ”¹â‰¡ refl = refl

,>rwâ‰¡ : âˆ€ (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) â†’ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (ğ”¹â‰¡ Î“â‰¡) ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§ 
      â†’ âŸ¦,>rwâŸ§ âŸ¦Î“â‚âŸ§ âŸ¦tâ‚âŸ§ b â‰¡á´¾ âŸ¦,>rwâŸ§ âŸ¦Î“â‚‚âŸ§ âŸ¦tâ‚‚âŸ§ b
,>rwâ‰¡ refl refl = refl

Î â‰¡ : âˆ€ Î“â‰¡ Aâ‰¡ â†’ âŸ¦Bâ‚âŸ§ â‰¡[ Tyâ‰¡ (,â‰¡ Î“â‰¡ Aâ‰¡) ]â‰¡á´¾ âŸ¦Bâ‚‚âŸ§
     â†’ âŸ¦Î âŸ§ âŸ¦Aâ‚âŸ§ âŸ¦Bâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Î âŸ§ âŸ¦Aâ‚‚âŸ§ âŸ¦Bâ‚‚âŸ§
Î â‰¡ refl refl refl = refl

âŸ¦TTâŸ§ : âŸ¦TmâŸ§ âŸ¦Î“âŸ§ âŸ¦ğ”¹âŸ§
âŸ¦TTâŸ§ _ = true

TTâ‰¡ : (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) â†’ âŸ¦TTâŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (ğ”¹â‰¡ Î“â‰¡) ]â‰¡á´¾ âŸ¦TTâŸ§ 
TTâ‰¡ refl = refl

âŸ¦FFâŸ§ : âŸ¦TmâŸ§ âŸ¦Î“âŸ§ âŸ¦ğ”¹âŸ§
âŸ¦FFâŸ§ _ = false

FFâ‰¡ : (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) â†’ âŸ¦FFâŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (ğ”¹â‰¡ Î“â‰¡) ]â‰¡á´¾ âŸ¦FFâŸ§ 
FFâ‰¡ refl = refl

âŸ¦Æ›âŸ§ : âŸ¦TmâŸ§ (âŸ¦,âŸ§ âŸ¦Î“âŸ§ âŸ¦AâŸ§) âŸ¦BâŸ§ â†’ âŸ¦TmâŸ§ âŸ¦Î“âŸ§ (âŸ¦Î âŸ§ âŸ¦AâŸ§ âŸ¦BâŸ§)
âŸ¦Æ›âŸ§ âŸ¦tâŸ§ Ï âŸ¦uâŸ§ = âŸ¦tâŸ§ (Ï Î£, âŸ¦uâŸ§)

-- TODO: Agda ICEs with "IMPOSSIBLE" here if we remove explicit quantification 
-- over |{âŸ¦Bâ‚‚âŸ§ âŸ¦tâ‚‚âŸ§}|!
Æ›â‰¡ : âˆ€ {âŸ¦Bâ‚‚âŸ§ âŸ¦tâ‚‚âŸ§} (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) (Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§)
     (Bâ‰¡ : âŸ¦Bâ‚âŸ§ â‰¡[ Tyâ‰¡ (,â‰¡ Î“â‰¡ Aâ‰¡) ]â‰¡á´¾ âŸ¦Bâ‚‚âŸ§)
   â†’ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ (,â‰¡ Î“â‰¡ Aâ‰¡) Bâ‰¡ ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§
   â†’ âŸ¦Æ›âŸ§ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (Î â‰¡ Î“â‰¡ Aâ‰¡ Bâ‰¡) ]â‰¡á´¾ âŸ¦Æ›âŸ§ âŸ¦tâ‚‚âŸ§
Æ›â‰¡ refl refl refl refl = refl

âŸ¦Æ›â»Â¹âŸ§ : âŸ¦TmâŸ§ âŸ¦Î“âŸ§ (âŸ¦Î âŸ§ âŸ¦AâŸ§ âŸ¦BâŸ§) â†’ âŸ¦TmâŸ§ (âŸ¦,âŸ§ âŸ¦Î“âŸ§ âŸ¦AâŸ§) âŸ¦BâŸ§
âŸ¦Æ›â»Â¹âŸ§ âŸ¦tâŸ§ (Ï Î£, âŸ¦uâŸ§) = âŸ¦tâŸ§ Ï âŸ¦uâŸ§

Æ›â»Â¹â‰¡ : âˆ€ {âŸ¦Bâ‚‚âŸ§ âŸ¦tâ‚‚âŸ§} (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) (Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§)
     (Bâ‰¡ : âŸ¦Bâ‚âŸ§ â‰¡[ Tyâ‰¡ (,â‰¡ Î“â‰¡ Aâ‰¡) ]â‰¡á´¾ âŸ¦Bâ‚‚âŸ§)
   â†’ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (Î â‰¡ Î“â‰¡ Aâ‰¡ Bâ‰¡) ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§
   â†’ âŸ¦Æ›â»Â¹âŸ§ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ (,â‰¡ Î“â‰¡ Aâ‰¡) Bâ‰¡ ]â‰¡á´¾ âŸ¦Æ›â»Â¹âŸ§ âŸ¦tâ‚‚âŸ§
Æ›â»Â¹â‰¡ refl refl refl refl = refl

âŸ¦[]TâŸ§ : âŸ¦TyâŸ§ âŸ¦Î“âŸ§ â†’ âŸ¦TmsâŸ§ âŸ¦Î”âŸ§ âŸ¦Î“âŸ§ â†’ âŸ¦TyâŸ§ âŸ¦Î”âŸ§
âŸ¦[]TâŸ§ âŸ¦AâŸ§ âŸ¦Î´âŸ§ Ï = âŸ¦AâŸ§ (âŸ¦Î´âŸ§ Ï)

[]Tâ‰¡ : âˆ€ Î“â‰¡ Î”â‰¡ â†’ âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§ â†’ âŸ¦Î´â‚âŸ§ â‰¡[ Tmsâ‰¡ Î”â‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Î´â‚‚âŸ§
     â†’ âŸ¦[]TâŸ§ âŸ¦Aâ‚âŸ§ âŸ¦Î´â‚âŸ§ â‰¡[ Tyâ‰¡ Î”â‰¡ ]â‰¡á´¾ âŸ¦[]TâŸ§ âŸ¦Aâ‚‚âŸ§ âŸ¦Î´â‚‚âŸ§
[]Tâ‰¡ refl refl refl refl = refl

âŸ¦Ï€â‚rwâŸ§ : âŸ¦TmsâŸ§ (âŸ¦,>rwâŸ§ âŸ¦Î“âŸ§ âŸ¦tâŸ§ b) âŸ¦Î“âŸ§
âŸ¦Ï€â‚rwâŸ§ = fst

Ï€â‚rwâ‰¡ : âˆ€ (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) (tâ‰¡ : âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (ğ”¹â‰¡ Î“â‰¡) ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§) 
      â†’ âŸ¦Ï€â‚rwâŸ§ â‰¡[ Tmsâ‰¡ (,>rwâ‰¡ {b = b} Î“â‰¡ tâ‰¡) Î“â‰¡ ]â‰¡á´¾ âŸ¦Ï€â‚rwâŸ§
Ï€â‚rwâ‰¡ refl refl = refl

âŸ¦ifâŸ§ : âˆ€ âŸ¦tâŸ§ 
     â†’ âŸ¦TmâŸ§ (âŸ¦,>rwâŸ§ âŸ¦Î“âŸ§ âŸ¦tâŸ§ true)  (âŸ¦[]TâŸ§ âŸ¦AâŸ§ âŸ¦Ï€â‚rwâŸ§)
     â†’ âŸ¦TmâŸ§ (âŸ¦,>rwâŸ§ âŸ¦Î“âŸ§ âŸ¦tâŸ§ false) (âŸ¦[]TâŸ§ âŸ¦AâŸ§ âŸ¦Ï€â‚rwâŸ§)
     â†’ âŸ¦TmâŸ§ âŸ¦Î“âŸ§ âŸ¦AâŸ§
âŸ¦ifâŸ§ âŸ¦tâŸ§ âŸ¦uâŸ§ âŸ¦vâŸ§ = Î» Ï â†’ Bool-splitá´¾ (âŸ¦tâŸ§ Ï) (Î» t~ â†’ âŸ¦uâŸ§ (Ï Î£, box t~)) 
                                             (Î» t~ â†’ âŸ¦vâŸ§ (Ï Î£, box t~))

ifâ‰¡ : âˆ€ (Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§) (Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§) 
        (tâ‰¡ : âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ (ğ”¹â‰¡ Î“â‰¡) ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§)
    â†’ âŸ¦uâ‚âŸ§ â‰¡[ Tmâ‰¡ (,>rwâ‰¡ Î“â‰¡ tâ‰¡) ([]Tâ‰¡ Î“â‰¡ (,>rwâ‰¡ Î“â‰¡ tâ‰¡) Aâ‰¡ (Ï€â‚rwâ‰¡ Î“â‰¡ tâ‰¡)) 
           ]â‰¡á´¾ âŸ¦uâ‚‚âŸ§
    â†’ âŸ¦vâ‚âŸ§ â‰¡[ Tmâ‰¡ (,>rwâ‰¡ Î“â‰¡ tâ‰¡) ([]Tâ‰¡ Î“â‰¡ (,>rwâ‰¡ Î“â‰¡ tâ‰¡) Aâ‰¡ (Ï€â‚rwâ‰¡ Î“â‰¡ tâ‰¡)) 
           ]â‰¡á´¾ âŸ¦vâ‚‚âŸ§
    â†’ âŸ¦ifâŸ§ âŸ¦tâ‚âŸ§ âŸ¦uâ‚âŸ§ âŸ¦vâ‚âŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ Aâ‰¡ ]â‰¡á´¾ âŸ¦ifâŸ§ âŸ¦tâ‚‚âŸ§ âŸ¦uâ‚‚âŸ§ âŸ¦vâ‚‚âŸ§
ifâ‰¡ refl refl refl refl refl = refl

âŸ¦_âŸ§Ctx : Ctx â†’ âŸ¦CtxâŸ§
âŸ¦_âŸ§Ty  : Ty Î“ â†’ âŸ¦TyâŸ§ âŸ¦ Î“ âŸ§Ctx
âŸ¦_âŸ§Tm  : Tm Î“ A â†’ âŸ¦TmâŸ§ âŸ¦ Î“ âŸ§Ctx âŸ¦ A âŸ§Ty
âŸ¦_âŸ§Tms : Tms Î” Î“ â†’ âŸ¦TmsâŸ§ âŸ¦ Î” âŸ§Ctx âŸ¦ Î“ âŸ§Ctx

variable
  Ï Ïâ‚ Ïâ‚‚ : âŸ¦Î“âŸ§

âŸ¦_âŸ§Ctx~ : Ctx~ Î“â‚ Î“â‚‚ â†’ âŸ¦ Î“â‚ âŸ§Ctx â‰¡á´¾ âŸ¦ Î“â‚‚ âŸ§Ctx
âŸ¦_âŸ§Ty~  : Ty~ Î“~ Aâ‚ Aâ‚‚ â†’ âŸ¦ Aâ‚ âŸ§Ty â‰¡[ congá´¾ âŸ¦TyâŸ§ âŸ¦ Î“~ âŸ§Ctx~ ]â‰¡á´¾ âŸ¦ Aâ‚‚ âŸ§Ty
âŸ¦_âŸ§Tm~ : Tm~ Î“~ A~ tâ‚ tâ‚‚ 
        â†’ âŸ¦ tâ‚ âŸ§Tm â‰¡[ Tmâ‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ ]â‰¡á´¾ âŸ¦ tâ‚‚ âŸ§Tm
âŸ¦_âŸ§Tms~ : Tms~ Î”~ Î“~ Î´â‚ Î´â‚‚ 
         â†’ âŸ¦ Î´â‚ âŸ§Tms â‰¡[ Tmsâ‰¡ âŸ¦ Î”~ âŸ§Ctx~ âŸ¦ Î“~ âŸ§Ctx~ ]â‰¡á´¾ âŸ¦ Î´â‚‚ âŸ§Tms

âŸ¦ğ”¹âŸ§â€² : âŸ¦ ğ”¹ {Î“ = Î“} âŸ§Ty â‰¡á´¾ Î» Ï â†’ Bool 
âŒœâŒğ”¹â‰¡ : âŸ¦ âŒœ b âŒğ”¹ âŸ§Tm â‰¡[ Tmâ‰¡ (refl {x = âŸ¦ Î“ âŸ§Ctx}) âŸ¦ğ”¹âŸ§â€² ]â‰¡á´¾ Î» Ï â†’ b


Tyâ‰¡-inst : âŸ¦Aâ‚âŸ§ â‰¡á´¾ âŸ¦Aâ‚‚âŸ§ â†’ âŸ¦Aâ‚âŸ§ Ï â‰¡á´¾ âŸ¦Aâ‚‚âŸ§ Ï
Tyâ‰¡-inst refl = refl

Tmâ‰¡-inst : âŸ¦tâ‚âŸ§ â‰¡á´¾ âŸ¦tâ‚‚âŸ§ â†’ âŸ¦tâ‚âŸ§ Ï â‰¡á´¾ âŸ¦tâ‚‚âŸ§ Ï
Tmâ‰¡-inst refl = refl

Tm[]â‰¡-inst : âˆ€ {Ï : âŸ¦ Î“ âŸ§Ctx} (Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡á´¾ âŸ¦Aâ‚‚âŸ§) â†’ âŸ¦tâ‚âŸ§ â‰¡[ Tmâ‰¡ refl Aâ‰¡ ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§ 
           â†’ âŸ¦tâ‚âŸ§ Ï â‰¡[ Tyâ‰¡-inst Aâ‰¡ ]â‰¡á´¾ âŸ¦tâ‚‚âŸ§ Ï
Tm[]â‰¡-inst refl refl = refl


âŸ¦ Îµ     âŸ§Ctx = âŠ¤
âŸ¦ Î“ , A âŸ§Ctx = Î£ âŸ¦ Î“ âŸ§Ctx âŸ¦ A âŸ§Ty

âŸ¦ Î“ , t >rw b âŸ§Ctx = Î£ âŸ¦ Î“ âŸ§Ctx (Î» Ï â†’ Box (âŸ¦ t âŸ§Tm Ï â‰¡[ Tyâ‰¡-inst âŸ¦ğ”¹âŸ§â€² ]â‰¡á´¾ b))

âŸ¦ ğ”¹ âŸ§Ty = Î» Ï â†’ Bool
âŸ¦ coe~ Î“~ A âŸ§Ty = coeá´¾ (Tyâ‰¡ âŸ¦ Î“~ âŸ§Ctx~) âŸ¦ A âŸ§Ty
âŸ¦ Î  A B     âŸ§Ty = Î» Ï â†’ âˆ€ x â†’ âŸ¦ B âŸ§Ty (Ï Î£, x)
âŸ¦ A [ Î´ ]   âŸ§Ty = Î» Ï â†’ âŸ¦ A âŸ§Ty (âŸ¦ Î´ âŸ§Tms Ï)
âŸ¦ if t A B  âŸ§Ty = Î» Ï â†’ Bool-rec (âŸ¦ t âŸ§Tm Ï) (âŸ¦ A âŸ§Ty Ï) (âŸ¦ B âŸ§Ty Ï)


âŸ¦TTâŸ§â€² : âŸ¦ TT {Î“ = Î“} âŸ§Tm â‰¡á´¾ Î» Ï â†’ true
âŸ¦FFâŸ§â€² : âŸ¦ FF {Î“ = Î“} âŸ§Tm â‰¡á´¾ Î» Ï â†’ false
âŸ¦[]âŸ§â€² : âŸ¦ t [ Î´ ] âŸ§Tm â‰¡á´¾ Î» Ï â†’ âŸ¦ t âŸ§Tm (âŸ¦ Î´ âŸ§Tms Ï)

âŸ¦ Ï€â‚ Î´  âŸ§Tms = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï .fst


âŸ¦ id     âŸ§Tms = Î» Ï â†’ Ï
âŸ¦ Ï€â‚rw Î´ âŸ§Tms = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï .fst                             
âŸ¦ coe~ Î”~ Î“~ Î´ âŸ§Tms = coeá´¾ (Tmsâ‰¡ âŸ¦ Î”~ âŸ§Ctx~ âŸ¦ Î“~ âŸ§Ctx~) âŸ¦ Î´ âŸ§Tms
âŸ¦ Îµ            âŸ§Tms = Î» Ï â†’ tt
âŸ¦ Î´ , t        âŸ§Tms = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï Î£, âŸ¦ t âŸ§Tm Ï

âŸ¦ ,rwâ„± {b = true} Î´ refl t~ âŸ§Tms 
  with symá´¾ (âŸ¦[]âŸ§â€² {Î´ = Î´}) âˆ™á´¾ âŸ¦ t~ âŸ§Tm~ âˆ™á´¾ âŸ¦TTâŸ§â€²
... | eq = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï Î£, box (Tmâ‰¡-inst eq)
âŸ¦ ,rwâ„± {b = false} Î´ refl t~ âŸ§Tms 
  with symá´¾ (âŸ¦[]âŸ§â€² {Î´ = Î´}) âˆ™á´¾ âŸ¦ t~ âŸ§Tm~ âˆ™á´¾ âŸ¦FFâŸ§â€²
... | eq = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï Î£,  box (Tmâ‰¡-inst eq)

âŸ¦ Î´ â¨¾ Ïƒ âŸ§Tms = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms (âŸ¦ Ïƒ âŸ§Tms Ï)

âŸ¦ coe~ Î“~ A~ t âŸ§Tm = coeá´¾ (Tmâ‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~) âŸ¦ t âŸ§Tm

âŸ¦ Æ› t     âŸ§Tm = Î» Ï        x â†’ âŸ¦ t âŸ§Tm (Ï Î£, x)
âŸ¦ Æ›â»Â¹ t   âŸ§Tm = Î» (Ï Î£, x)   â†’ âŸ¦ t âŸ§Tm Ï x
âŸ¦ TT      âŸ§Tm = Î» Ï          â†’ true
âŸ¦ FF      âŸ§Tm = Î» Ï          â†’ false
âŸ¦ t [ Î´ ] âŸ§Tm = Î» Ï          â†’ âŸ¦ t âŸ§Tm (âŸ¦ Î´ âŸ§Tms Ï)
âŸ¦ Ï€â‚‚ Î´  âŸ§Tm = Î» Ï â†’ âŸ¦ Î´ âŸ§Tms Ï .snd
âŸ¦ if t u v âŸ§Tm = Î» Ï â†’ Bool-splitá´¾ (âŸ¦ t âŸ§Tm Ï) (Î» t~ â†’ âŸ¦ u âŸ§Tm (Ï Î£, box t~)) 
                                               (Î» t~ â†’ âŸ¦ v âŸ§Tm (Ï Î£, box t~))
âŸ¦TTâŸ§â€² = refl
âŸ¦FFâŸ§â€² = refl
âŸ¦[]âŸ§â€² = refl

âŸ¦ğ”¹âŸ§â€² = refl

âŒœâŒğ”¹â‰¡ {b = false} = refl
âŒœâŒğ”¹â‰¡ {b = true}  = refl

âŸ¦ rfl~         âŸ§Ctx~ = refl
âŸ¦ sym~ Î“~      âŸ§Ctx~ = symá´¾ âŸ¦ Î“~ âŸ§Ctx~
âŸ¦ Î“â‚â‚‚~ âˆ™~ Î“â‚‚â‚ƒ~ âŸ§Ctx~ = âŸ¦ Î“â‚â‚‚~ âŸ§Ctx~ âˆ™á´¾ âŸ¦ Î“â‚‚â‚ƒ~ âŸ§Ctx~
âŸ¦ Î“~ , A~      âŸ§Ctx~ = ,â‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~
âŸ¦ Î“~ , t~ >rw  âŸ§Ctx~ = ,>rwâ‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ t~ âŸ§Tm~

âŸ¦ rfl~              âŸ§Ty~ = refl
âŸ¦ sym~ A~           âŸ§Ty~ = sym[]á´¾ âŸ¦ A~ âŸ§Ty~
âŸ¦ Aâ‚â‚‚~ âˆ™~ Aâ‚‚â‚ƒ~      âŸ§Ty~ = âŸ¦ Aâ‚â‚‚~ âŸ§Ty~ âˆ™[]á´¾ âŸ¦ Aâ‚‚â‚ƒ~ âŸ§Ty~
âŸ¦ coh               âŸ§Ty~ = coh[]á´¾
âŸ¦ ğ”¹ {Î“~ = Î“~}       âŸ§Ty~ = ğ”¹â‰¡ âŸ¦ Î“~ âŸ§Ctx~
âŸ¦ Î  {Î“~ = Î“~} A~ B~ âŸ§Ty~ = Î â‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ âŸ¦ B~ âŸ§Ty~
âŸ¦ _[_] {Î“~ = Î“~} {Î”~ = Î”~} A~ Î´~ âŸ§Ty~ 
  = []Tâ‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ Î”~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ (âŸ¦ Î´~ âŸ§Tms~)
âŸ¦ if t~ A~ B~ âŸ§Ty~ = {!   !}

âŸ¦ ifTT              âŸ§Ty~ = refl
âŸ¦ ifFF              âŸ§Ty~ = refl
âŸ¦ Î []               âŸ§Ty~ = refl
âŸ¦ if[]              âŸ§Ty~ = refl
âŸ¦ ğ”¹[]               âŸ§Ty~ = refl
âŸ¦ [][]              âŸ§Ty~ = refl
âŸ¦ [id]              âŸ§Ty~ = refl

-- Specialisation of |coh[]á´¾| to assist with termination
cohTm : âˆ€ {âŸ¦tâŸ§ : âŸ¦TmâŸ§ âŸ¦Î“â‚âŸ§ âŸ¦Aâ‚âŸ§} {Î“â‰¡ : âŸ¦Î“â‚âŸ§ â‰¡á´¾ âŸ¦Î“â‚‚âŸ§} 
          {Aâ‰¡ : âŸ¦Aâ‚âŸ§ â‰¡[ Tyâ‰¡ Î“â‰¡ ]â‰¡á´¾ âŸ¦Aâ‚‚âŸ§} 
      â†’ âŸ¦tâŸ§ â‰¡[ Tmâ‰¡ Î“â‰¡ Aâ‰¡ ]â‰¡á´¾ coeá´¾ (Tmâ‰¡ Î“â‰¡ Aâ‰¡) âŸ¦tâŸ§

âŸ¦ rfl~         âŸ§Tm~ = refl
âŸ¦ sym~ t~      âŸ§Tm~ = sym[]á´¾ âŸ¦ t~ âŸ§Tm~
âŸ¦ tâ‚â‚‚~ âˆ™~ tâ‚‚â‚ƒ~ âŸ§Tm~ = âŸ¦ tâ‚â‚‚~ âŸ§Tm~ âˆ™[]á´¾ âŸ¦ tâ‚‚â‚ƒ~ âŸ§Tm~

âŸ¦ coh {Î“~ = Î“~} {A~ = A~} âŸ§Tm~ = cohTm {Î“â‰¡ = âŸ¦ Î“~ âŸ§Ctx~} {Aâ‰¡ = âŸ¦ A~ âŸ§Ty~}

âŸ¦ Æ›_ {Î“~ = Î“~} {A~ = A~} {B~ = B~} t~   âŸ§Tm~ 
  = Æ›â‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ âŸ¦ B~ âŸ§Ty~ âŸ¦ t~ âŸ§Tm~
âŸ¦ Æ›â»Â¹_ {Î“~ = Î“~} {A~ = A~} {B~ = B~} t~ âŸ§Tm~ 
  = Æ›â»Â¹â‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ âŸ¦ B~ âŸ§Ty~ âŸ¦ t~ âŸ§Tm~
âŸ¦ Ï€â‚‚ Î´~        âŸ§Tm~ = {!   !}
âŸ¦ TT Î“~        âŸ§Tm~ = TTâ‰¡ âŸ¦ Î“~ âŸ§Ctx~
âŸ¦ FF Î“~        âŸ§Tm~ = FFâ‰¡ âŸ¦ Î“~ âŸ§Ctx~
âŸ¦ if {Î“~ = Î“~} {A~ = A~} t~ u~ v~  âŸ§Tm~ 
  = ifâ‰¡ âŸ¦ Î“~ âŸ§Ctx~ âŸ¦ A~ âŸ§Ty~ âŸ¦ t~ âŸ§Tm~ âŸ¦ u~ âŸ§Tm~ âŸ¦ v~ âŸ§Tm~
âŸ¦ t~ [ Î´~ ]    âŸ§Tm~ = {!   !}
âŸ¦ Ï€â‚‚rw {b = true}  Î´ âŸ§Tm~ with âŸ¦ Î´ âŸ§Tms
... | âŸ¦Î´âŸ§ = funextá´¾ (Î» Ï â†’ âŸ¦Î´âŸ§ Ï .snd .unbox)
âŸ¦ Ï€â‚‚rw {b = false} Î´ âŸ§Tm~ with âŸ¦ Î´ âŸ§Tms
... | âŸ¦Î´âŸ§ = funextá´¾ (Î» Ï â†’ âŸ¦Î´âŸ§ Ï .snd .unbox)
âŸ¦ TT[]               âŸ§Tm~ = refl
âŸ¦ FF[]               âŸ§Tm~ = refl
âŸ¦ Æ›[]                âŸ§Tm~ = refl
âŸ¦ if[]               âŸ§Tm~ = refl
âŸ¦ [id]               âŸ§Tm~ = refl
âŸ¦ [][]               âŸ§Tm~ = refl
âŸ¦ ifTT               âŸ§Tm~ = refl
âŸ¦ ifFF               âŸ§Tm~ = refl
âŸ¦ Î²                  âŸ§Tm~ = refl
âŸ¦ Î·                  âŸ§Tm~ = refl
âŸ¦ Ï€â‚‚,                âŸ§Tm~ = refl
âŸ¦ Ï€â‚‚â¨¾                âŸ§Tm~ = refl

cohTm {Î“â‰¡ = refl} {Aâ‰¡ = refl} = refl

âŸ¦ rfl~              âŸ§Tms~ = refl
âŸ¦ sym~ Î´~           âŸ§Tms~ = sym[]á´¾ âŸ¦ Î´~ âŸ§Tms~
âŸ¦ Î´â‚â‚‚~ âˆ™~ Î´â‚‚â‚ƒ~      âŸ§Tms~ = âŸ¦ Î´â‚â‚‚~ âŸ§Tms~ âˆ™[]á´¾ âŸ¦ Î´â‚‚â‚ƒ~ âŸ§Tms~
âŸ¦ coh               âŸ§Tms~ = coh[]á´¾
âŸ¦ Îµ                 âŸ§Tms~ = {!   !}
âŸ¦ Î´~ , t~           âŸ§Tms~ = {!   !}
âŸ¦ ,rw~ Î´~           âŸ§Tms~ = {!   !}
âŸ¦ id                âŸ§Tms~ = {!   !}
âŸ¦ Î´~ â¨¾ Ïƒ~           âŸ§Tms~ = {!   !}
âŸ¦ Ï€â‚ A~ Î´~          âŸ§Tms~ = {!   !}
âŸ¦ Ï€â‚rw t~ Î´~        âŸ§Tms~ = {!   !}
âŸ¦ ÎµÎ·                âŸ§Tms~ = refl
âŸ¦ ,Î·                âŸ§Tms~ = refl
âŸ¦ ,rwÎ· {b = true}   âŸ§Tms~ = refl
âŸ¦ ,rwÎ· {b = false}  âŸ§Tms~ = refl
âŸ¦ Ï€â‚,               âŸ§Tms~ = refl
âŸ¦ Ï€â‚rw, {b = false} âŸ§Tms~ = refl
âŸ¦ Ï€â‚rw, {b = true}  âŸ§Tms~ = refl
âŸ¦ Ï€â‚â¨¾               âŸ§Tms~ = refl
âŸ¦ Ï€â‚rwâ¨¾             âŸ§Tms~ = refl
âŸ¦ idâ¨¾               âŸ§Tms~ = refl
âŸ¦ â¨¾id               âŸ§Tms~ = refl
âŸ¦ â¨¾â¨¾                âŸ§Tms~ = refl
âŸ¦ ,â¨¾                âŸ§Tms~ = refl
âŸ¦ ,rwâ¨¾ {b = true}   âŸ§Tms~ = refl
âŸ¦ ,rwâ¨¾ {b = false}  âŸ§Tms~ = refl
 